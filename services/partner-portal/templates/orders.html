{% extends "base.html" %}
{% block title %}Orders - {{ partner.business_name }}{% endblock %}

{% block content %}
<h1>{{ partner.business_name }} - Order Queue</h1>
<p>Accept, reject, and update order status.</p>

<div id="orders-list">
    {% for item in orders %}
    <div class="order-card" data-order-id="{{ item.order_id }}" data-leg-id="{{ item.leg_id }}" style="margin:var(--spacing-md) 0;padding:var(--spacing-md);border:1px solid var(--color-border);border-radius:var(--radius-lg);background:var(--color-surface);">
        <h3>Order {{ item.order_id[:8] }}... Â· {{ item.leg.status }}</h3>
        <p>Created: {{ item.order.created_at[:19] if item.order.created_at else '-' }}</p>
        <ul>
            {% for it in (item.order.order_items or []) %}
            <li>{{ it.item_name }} x{{ it.quantity }} - {{ it.currency }} {{ it.total_price }}</li>
            {% endfor %}
        </ul>
        {% if item.leg.status == 'pending' %}
        <div class="order-actions">
            <label>Prep time (mins)</label>
            <input type="number" class="prep-mins" value="15" min="1" max="120" style="width:60px;">
            <button type="button" class="btn-accept">Accept</button>
            <button type="button" class="btn-reject">Reject</button>
        </div>
        <div class="reject-form" style="display:none;margin-top:8px;">
            <input type="text" class="reject-reason" placeholder="Reason for rejection">
            <button type="button" class="btn-confirm-reject">Confirm Reject</button>
        </div>
        {% elif item.leg.status in ['accepted','preparing'] %}
        <button type="button" class="btn-status" data-status="preparing">Mark Preparing</button>
        <button type="button" class="btn-status" data-status="ready">Mark Ready</button>
        {% elif item.leg.status == 'ready' %}
        <button type="button" class="btn-status" data-status="fulfilled">Mark Fulfilled</button>
        {% endif %}
    </div>
    {% else %}
    <p style="color:var(--color-text-secondary);">No pending orders.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const partnerId = '{{ partner.id }}';

    document.querySelectorAll('.btn-accept').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.order-card');
            const orderId = card.dataset.orderId;
            const legId = card.dataset.legId;
            const prepMins = parseInt(card.querySelector('.prep-mins').value) || 15;
            try {
                const res = await fetch(`/api/v1/partners/${partnerId}/orders/${orderId}/legs/${legId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preparation_mins: prepMins }),
                });
                if (res.ok) location.reload();
                else alert((await res.json()).detail || 'Failed');
            } catch (e) { alert(e.message); }
        });
    });

    document.querySelectorAll('.btn-reject').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.order-actions').style.display = 'none';
            btn.closest('.order-card').querySelector('.reject-form').style.display = 'block';
        });
    });

    document.querySelectorAll('.btn-confirm-reject').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.order-card');
            const orderId = card.dataset.orderId;
            const legId = card.dataset.legId;
            const reason = card.querySelector('.reject-reason').value || 'Unavailable';
            try {
                const res = await fetch(`/api/v1/partners/${partnerId}/orders/${orderId}/legs/${legId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reject_reason: reason }),
                });
                if (res.ok) location.reload();
                else alert((await res.json()).detail || 'Failed');
            } catch (e) { alert(e.message); }
        });
    });

    document.querySelectorAll('.btn-status').forEach(btn => {
        btn.addEventListener('click', async () => {
            const card = btn.closest('.order-card');
            const orderId = card.dataset.orderId;
            const legId = card.dataset.legId;
            const status = btn.dataset.status;
            try {
                const res = await fetch(`/api/v1/partners/${partnerId}/orders/${orderId}/legs/${legId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status }),
                });
                if (res.ok) location.reload();
                else alert((await res.json()).detail || 'Failed');
            } catch (e) { alert(e.message); }
        });
    });
</script>
{% endblock %}
