{% extends "base.html" %}
{% block title %}Change Requests - {{ partner.business_name }}{% endblock %}

{% block content %}
<h1>{{ partner.business_name }} - Change Requests</h1>
<p><a href="/api/v1/partners/{{ partner.id }}/settings">Channel settings</a></p>
<button type="button" onclick="location.reload()" style="margin-bottom:var(--spacing-md);">Refresh</button>

<div id="list">
    {% for n in negotiations %}
    <div class="negotiation" data-id="{{ n.id }}" style="margin:var(--spacing-md) 0;padding:var(--spacing-md);border:1px solid var(--color-border);border-radius:var(--radius-lg);background:var(--color-surface);">
        <h3 style="margin:0 0 var(--spacing-sm) 0;font-size:var(--text-base);">Change request #{{ n.id[:8] }}...</h3>
        <div class="meta" style="font-size:var(--text-sm);color:var(--color-text-secondary);margin-bottom:var(--spacing-sm);">
            Order {{ n.order_id[:8] }}... Â· {{ n.created_at[:19] if n.created_at else '' }}
        </div>
        {% set orig = n.original_request or {} %}
        {% set oi = orig.get('original_item') or {} %}
        {% set rc = orig.get('requested_change') or {} %}
        <div class="original" style="font-size:var(--text-sm);margin:var(--spacing-xs) 0;">Original: {{ oi.get('name', 'Item') }} - ${{ oi.get('price', '') }}</div>
        <div class="requested" style="font-size:var(--text-sm);margin:var(--spacing-xs) 0;color:var(--color-success);">Requested: {{ rc.get('description', rc.get('requested_item', 'Change')) }}</div>
        <div class="actions" style="margin-top:var(--spacing-md);">
            <button class="btn-accept" onclick="respond('{{ n.id }}', 'accept')">Accept</button>
            <button class="btn-reject" onclick="respond('{{ n.id }}', 'reject')">Reject</button>
        </div>
        <div id="msg-{{ n.id }}"></div>
    </div>
    {% else %}
    <div class="empty" style="color:var(--color-text-secondary);padding:var(--spacing-xl);text-align:center;">No pending change requests. Keep this page open; new requests will appear when you refresh.</div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const partnerId = '{{ partner.id }}';
    async function respond(negotiationId, response) {
        const msgEl = document.getElementById('msg-' + negotiationId);
        msgEl.className = '';
        msgEl.textContent = 'Sending...';
        try {
            const res = await fetch(`/api/v1/partners/${partnerId}/respond`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    negotiation_id: negotiationId,
                    response: response,
                    rejection_reason: response === 'reject' ? 'Unable to fulfill' : null,
                }),
            });
            const data = await res.json();
            if (res.ok) {
                msgEl.className = 'success';
                msgEl.textContent = 'Response sent.';
                document.querySelector(`.negotiation[data-id="${negotiationId}"]`)?.remove();
            } else {
                msgEl.className = 'error';
                msgEl.textContent = data.detail || 'Failed';
            }
        } catch (err) {
            msgEl.className = 'error';
            msgEl.textContent = err.message || 'Request failed';
        }
    }
</script>
{% endblock %}
