{% extends "base.html" %}
{% block title %}Products - {{ partner.business_name }}{% endblock %}

{% block content %}
<h1>{{ partner.business_name }} - Products</h1>
<p><a href="/api/v1/partners/{{ partner.id }}/settings">Configure channel</a></p>
<h2>Add Product</h2>
<form id="form">
    <label for="name">Product Name *</label>
    <input type="text" id="name" required>

    <label for="price">Price *</label>
    <input type="number" id="price" step="0.01" min="0" required>

    <label for="description">Description</label>
    <input type="text" id="description" placeholder="Optional">

    <button type="submit">Add Product</button>
</form>
<div id="message"></div>
<h2>Your Products</h2>
<table style="width:100%;border-collapse:collapse;margin-top:var(--spacing-md);">
    <thead>
        <tr>
            <th style="padding:var(--spacing-sm);text-align:left;border-bottom:1px solid var(--color-border);">Name</th>
            <th style="padding:var(--spacing-sm);text-align:left;border-bottom:1px solid var(--color-border);">Price</th>
            <th style="padding:var(--spacing-sm);text-align:left;border-bottom:1px solid var(--color-border);">Currency</th>
        </tr>
    </thead>
    <tbody>
        {% for p in products %}
        <tr>
            <td style="padding:var(--spacing-sm);border-bottom:1px solid var(--color-border);">
                <a href="/api/v1/partners/{{ partner.id }}/products/{{ p.id }}">{{ p.name }}</a>
            </td>
            <td style="padding:var(--spacing-sm);border-bottom:1px solid var(--color-border);">{{ p.price }}</td>
            <td style="padding:var(--spacing-sm);border-bottom:1px solid var(--color-border);">{{ p.currency }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3" style="padding:var(--spacing-md);color:var(--color-text-secondary);">No products yet. Add one above.</td></tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block extra_scripts %}
<script>
    const partnerId = '{{ partner.id }}';
    document.getElementById('form').onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById('message');
        msg.className = '';
        msg.textContent = '';
        try {
            const res = await fetch(`/api/v1/partners/${partnerId}/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: document.getElementById('name').value,
                    price: parseFloat(document.getElementById('price').value),
                    description: document.getElementById('description').value || null,
                }),
            });
            const data = await res.json();
            if (res.ok) {
                msg.className = 'success';
                msg.textContent = 'Product added! Refresh to see it.';
                setTimeout(() => location.reload(), 1000);
            } else {
                msg.className = 'error';
                msg.textContent = data.detail || 'Failed to add product';
            }
        } catch (err) {
            msg.className = 'error';
            msg.textContent = err.message || 'Request failed';
        }
    };
</script>
{% endblock %}
