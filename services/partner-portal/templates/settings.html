{% extends "base.html" %}
{% block title %}Communication Channel - {{ partner.business_name }}{% endblock %}

{% block content %}
<h1>{{ partner.business_name }} - Communication Channel</h1>
<p><a href="/api/v1/partners/{{ partner.id }}/products">Manage products</a></p>
<p>Choose how you receive change requests (e.g. "customer wants pink instead of red"). You can respond via the selected channel.</p>

<form id="form">
    <div class="channel-option {{ 'selected' if channel == 'api' else '' }}" data-channel="api">
        <input type="radio" name="channel" id="ch_api" value="api" {{ 'checked' if channel == 'api' else '' }}>
        <label for="ch_api">Your system (API webhook)</label>
        <div class="channel-detail">
            <label for="webhook_url">Webhook URL *</label>
            <input type="url" id="webhook_url" value="{{ channel_identifier if channel == 'api' else '' }}" placeholder="https://your-server.com/webhook">
            <p class="hint">We POST change requests here. You respond via POST to our /webhooks/partner endpoint.</p>
        </div>
    </div>

    <div class="channel-option {{ 'selected' if channel == 'demo_chat' else '' }}" data-channel="demo_chat">
        <input type="radio" name="channel" id="ch_demo" value="demo_chat" {{ 'checked' if channel == 'demo_chat' else '' }}>
        <label for="ch_demo">Demo chat (built-in)</label>
        <div class="channel-detail">
            <p class="hint">Open the link below to receive and respond to change requests. No setup required.</p>
            <p class="demochat-link"><a href="/api/v1/partners/{{ partner.id }}/demo-chat" target="_blank">Open demo chat</a></p>
        </div>
    </div>

    <div class="channel-option {{ 'selected' if channel == 'whatsapp' else '' }}" data-channel="whatsapp">
        <input type="radio" name="channel" id="ch_whatsapp" value="whatsapp" {{ 'checked' if channel == 'whatsapp' else '' }}>
        <label for="ch_whatsapp">WhatsApp</label>
        <div class="channel-detail">
            <label for="whatsapp_phone">Phone number (with country code)</label>
            <input type="tel" id="whatsapp_phone" value="{{ channel_identifier if channel == 'whatsapp' else '' }}" placeholder="+14155551234">
            <p class="hint">We send change requests via WhatsApp. Reply with ACCEPT or REJECT.</p>
        </div>
    </div>

    <div class="channel-option {{ 'selected' if channel == 'chatgpt' else '' }}" data-channel="chatgpt">
        <input type="radio" name="channel" id="ch_chatgpt" value="chatgpt" {{ 'checked' if channel == 'chatgpt' else '' }}>
        <label for="ch_chatgpt">ChatGPT (Custom GPT actions)</label>
        <div class="channel-detail">
            <p class="hint">Import <a href="/docs/openapi-partner-actions.yaml" target="_blank">OpenAPI spec</a> when creating your Custom GPT. Your GPT fetches pending requests and submits responses.</p>
            <p class="demochat-link"><a href="/api/v1/partners/{{ partner.id }}/demo-chat" target="_blank">Or use demo chat</a></p>
        </div>
    </div>

    <div class="channel-option {{ 'selected' if channel == 'gemini' else '' }}" data-channel="gemini">
        <input type="radio" name="channel" id="ch_gemini" value="gemini" {{ 'checked' if channel == 'gemini' else '' }}>
        <label for="ch_gemini">Gemini (Extensions / API)</label>
        <div class="channel-detail">
            <p class="hint">Connect Gemini to our API using the OpenAPI spec. Gemini fetches pending requests and submits responses.</p>
            <p class="demochat-link"><a href="/api/v1/partners/{{ partner.id }}/demo-chat" target="_blank">Or use demo chat</a></p>
        </div>
    </div>

    <button type="submit">Save channel</button>
</form>
<div id="message"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    const partnerId = '{{ partner.id }}';
    document.querySelectorAll('.channel-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.channel-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input[type=radio]').checked = true;
        });
    });

    document.getElementById('form').onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById('message');
        msg.className = '';
        msg.textContent = '';
        const ch = document.querySelector('input[name=channel]:checked').value;
        let identifier = '';
        if (ch === 'api') identifier = document.getElementById('webhook_url').value.trim();
        else if (ch === 'whatsapp') identifier = document.getElementById('whatsapp_phone').value.trim();
        else identifier = 'enabled';

        if (ch === 'api' && !identifier) { msg.className = 'error'; msg.textContent = 'Webhook URL required'; return; }
        if (ch === 'whatsapp' && !identifier) { msg.className = 'error'; msg.textContent = 'Phone number required'; return; }

        try {
            const res = await fetch(`/api/v1/partners/${partnerId}/channel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel: ch, channel_identifier: identifier }),
            });
            const data = await res.json();
            if (res.ok) {
                msg.className = 'success';
                msg.textContent = 'Channel saved.';
            } else {
                msg.className = 'error';
                msg.textContent = data.detail || 'Failed to save';
            }
        } catch (err) {
            msg.className = 'error';
            msg.textContent = err.message || 'Request failed';
        }
    };
</script>
{% endblock %}
